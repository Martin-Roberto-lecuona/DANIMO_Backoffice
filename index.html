<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Danimo — Tabla Mejorada</title>
  <style>
    :root{
      --color1: #f7a1b2;
      --color2: #f6c6d7;
      --fondo:   #f4e1e6;
      --color4: #e3c8e4;
      --color5: #d2a8d6;
      --oscuro: #595154;
      --card-shadow: 0 6px 20px rgba(89,81,84,0.08);
      --radius: 12px;
      --max-width: 980px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: linear-gradient(180deg, var(--fondo), #fff);
      color:var(--oscuro);
      display:flex;
      justify-content:center;
      padding:36px;
    }

    .container{
      width:100%;
      max-width:var(--max-width);
      background:white;
      border-radius:14px;
      box-shadow:var(--card-shadow);
      padding:20px;
      border:1px solid rgba(89,81,84,0.05);
    }

    header{display:flex;gap:16px;align-items:center;margin-bottom:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--color1),var(--color4));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:22px}
    h1{margin:0;font-size:18px}
    .lead{margin:0;color:#6b6366;font-size:13px}

    .form-row{display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap}
    input[type="email"]{flex:1 1 360px;padding:12px;border-radius:10px;border:1px solid rgba(89,81,84,0.08);background:linear-gradient(180deg, rgba(246,198,215,0.35), rgba(226,200,228,0.18));outline:none;font-size:14px}
    .controls{display:flex;gap:8px;align-items:center}

    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:linear-gradient(90deg,var(--color1),var(--color4));color:white}
    .btn-danger{background:linear-gradient(90deg,#f58a98,#e06aa1);color:white}
    .btn-ghost{background:transparent;border:1px dashed rgba(89,81,84,0.08);color:var(--oscuro)}

    .info-card{margin-top:18px;border-radius:10px;padding:14px;background:linear-gradient(180deg, rgba(210,168,214,0.04), rgba(242,231,241,0.02));border:1px solid rgba(210,168,214,0.04)}
    .meta{display:flex;gap:12px;font-size:13px;color:#5f5659;margin-bottom:12px}

    .result-area{margin-top:12px;max-height:520px;overflow:auto;background:white;border-radius:8px;padding:12px;border:1px solid rgba(89,81,84,0.03)}
    table.data{width:100%;border-collapse:collapse;font-size:14px}
    table.data th, table.data td{padding:10px;border-bottom:1px solid rgba(89,81,84,0.05);vertical-align:top;text-align:left}
    table.data th{background:linear-gradient(90deg,var(--color2),var(--color5));color:var(--oscuro);font-weight:700}
    table.subtable th{background:linear-gradient(90deg,var(--color5),var(--color4));color:white;font-weight:700}
    pre.json{white-space:pre-wrap;font-size:13px;margin:0}

    .small{font-size:12px;color:#6f6668}
    @media (max-width:640px){input[type="email"]{flex-basis:100%}.controls{flex-direction:column;width:100%}.btn{width:100%}}
  </style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <div class="logo">D</div>
      <div>
        <h1>Panel Danimo — Consulta</h1>
        <p class="lead">Ingresa un correo y trae la info. ImportantEvents y SleepRegisters se muestran como sub-tablas.</p>
      </div>
    </header>

    <div class="form-row" aria-label="formulario principal">
      <input id="email" type="email" placeholder="usuario@dominio.com" aria-label="email usuario" />
      <div class="controls">
        <button id="btnFetch" class="btn btn-primary">Traer info</button>
        <button id="btnReset" class="btn btn-danger" title="Borrar datos del día">Borrar datos del día</button>
        <button id="btnClearUI" class="btn btn-ghost" title="Limpiar resultados">Limpiar</button>
      </div>
    </div>

    <div class="info-card" id="infoCard" hidden>
      <div class="meta">
        <div id="statusText" class="small">Estado: listo</div>
        <div id="lastCalled" class="small" aria-hidden="true"></div>
      </div>

      <div class="result-area" id="resultArea" aria-live="polite">
        <!-- tabla principal -->
      </div>
    </div>
  </div>

  <script>
    const API_FETCH_URL = "https://danimo-fre6fpbjezcyhxed.canadacentral-01.azurewebsites.net/auth/data";
    const API_RESET_URL = "https://danimo-fre6fpbjezcyhxed.canadacentral-01.azurewebsites.net/auth/reset";

    // Helpers
    function showStatus(txt){ document.getElementById("statusText").textContent = "Estado: " + txt; }
    function updateLastCalled(){ document.getElementById("lastCalled").textContent = "Última acción: " + new Date().toLocaleString(); }

    function buildUrl(base, email){
      try {
        const u = new URL(base);
        u.searchParams.set("email", email);
        return u.toString();
      } catch(e){
        // fallback simple
        return base + (base.includes("?") ? "&" : "?") + "email=" + encodeURIComponent(email);
      }
    }

    // crea una celda con texto seguro
    function tdText(text){
      const td = document.createElement("td");
      if (text === null || text === undefined) td.textContent = "";
      else td.textContent = String(text);
      return td;
    }

    // render subtabla para ImportantEvents (espera objeto o array)
    function renderImportantEvents(value){
      const wrapper = document.createElement("div");
      if (!value || (typeof value === 'object' && Object.keys(value).length === 0)) {
        wrapper.textContent = "(sin eventos importantes)";
        return wrapper;
      }

      // si es array de eventos
      let rows = [];
      if (Array.isArray(value)) {
        rows = value.map((v, i) => ({key: String(i), val: v}));
      } else {
        // objeto: keys -> eventos
        rows = Object.keys(value).map(k => ({ key: k, val: value[k] }));
      }

      const table = document.createElement("table");
      table.className = "data subtable";
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      ["Evento", "Detalle"].forEach(h => { const th = document.createElement("th"); th.textContent = h; trh.appendChild(th); });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      rows.forEach(r => {
        const tr = document.createElement("tr");
        const tdKey = document.createElement("td");
        tdKey.textContent = r.key;
        tr.appendChild(tdKey);

        const tdVal = document.createElement("td");
        if (typeof r.val === "object" && r.val !== null) {
          const pre = document.createElement("pre");
          pre.className = "json";
          pre.textContent = JSON.stringify(r.val, null, 2);
          tdVal.appendChild(pre);
        } else {
          tdVal.textContent = String(r.val);
        }
        tr.appendChild(tdVal);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wrapper.appendChild(table);
      return wrapper;
    }

    // render subtabla para SleepRegisters: ordena por fecha (soporta array de objetos con campo date o objeto con keys fecha)
    function renderSleepRegisters(value){
      const wrapper = document.createElement("div");
      if (!value || (typeof value === 'object' && Object.keys(value).length === 0)) {
        wrapper.textContent = "(sin registros de sueño)";
        return wrapper;
      }

      let records = [];

      if (Array.isArray(value)) {
        // array de registros — intentamos extraer campo date o createdAt
        records = value.map(r => {
          // buscar la clave con fecha
          let dateStr = null;
          if (r.date) dateStr = r.date;
          else if (r.createdAt) dateStr = r.createdAt;
          else {
            // buscar primer campo que parezca fecha
            for (const k in r) {
              if (typeof r[k] === "string" && /\d{4}-\d{2}-\d{2}/.test(r[k])) { dateStr = r[k]; break; }
            }
          }
          return { date: dateStr, record: r };
        });
      } else {
        // si es objeto donde keys son fechas
        records = Object.keys(value).map(k => ({ date: k, record: value[k] }));
      }

      // normalizar y filtrar registros sin fecha parseable
      records = records.map(r => {
        const d = r.date ? new Date(r.date) : null;
        return { dateRaw: r.date || null, dateObj: isNaN(d) ? null : d, record: r.record };
      });

      // ordenar: con fecha -> descendente o ascendente? pediste "ordenadas como subtabla" — vamos ascendente (antiguo -> nuevo)
      records.sort((a,b) => {
        if (a.dateObj && b.dateObj) return a.dateObj - b.dateObj;
        if (a.dateObj) return -1;
        if (b.dateObj) return 1;
        return 0;
      });

      const table = document.createElement("table");
      table.className = "data subtable";
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      ["Fecha", "Detalle"].forEach(h => { const th = document.createElement("th"); th.textContent = h; trh.appendChild(th); });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      records.forEach(r => {
        const tr = document.createElement("tr");
        const tdDate = document.createElement("td");
        tdDate.textContent = r.dateRaw ? (r.dateObj ? r.dateObj.toISOString().split('T')[0] : r.dateRaw) : "(sin fecha)";
        tr.appendChild(tdDate);

        const tdDetail = document.createElement("td");
        if (typeof r.record === "object" && r.record !== null) {
          const pre = document.createElement("pre");
          pre.className = "json";
          pre.textContent = JSON.stringify(r.record, null, 2);
          tdDetail.appendChild(pre);
        } else {
          tdDetail.textContent = String(r.record);
        }
        tr.appendChild(tdDetail);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wrapper.appendChild(table);
      return wrapper;
    }

    // render tabla principal con manejo especial de ImportantEvents y SleepRegisters
    function renderMainTable(obj){
      const container = document.getElementById("resultArea");
      container.innerHTML = ""; // limpiar

      if (!obj || typeof obj !== "object"){
        container.textContent = "Respuesta inválida";
        return;
      }

      const table = document.createElement("table");
      table.className = "data";
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      ["Campo","Valor"].forEach(h => { const th = document.createElement("th"); th.textContent = h; trh.appendChild(th); });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      // Iterar claves en orden: id, firstName... para mejor legibilidad opcionalmente
      const preferredOrder = ["id","firstName","lastName","email","birthDate","gender","ImportantEvents","SleepRegisters"];
      const keys = Array.from(new Set([...preferredOrder.filter(k=>k in obj), ...Object.keys(obj).filter(k=>!preferredOrder.includes(k))]));

      keys.forEach(key => {
        const val = obj[key];
        const tr = document.createElement("tr");
        const tdk = document.createElement("td");
        tdk.textContent = key;
        tr.appendChild(tdk);

        const tdv = document.createElement("td");

        if (key === "ImportantEvents") {
          tdv.appendChild(renderImportantEvents(val));
        } else if (key === "SleepRegisters") {
          tdv.appendChild(renderSleepRegisters(val));
        } else if (typeof val === "object" && val !== null) {
          // otros objetos los mostramos como JSON preformateado
          const pre = document.createElement("pre");
          pre.className = "json";
          pre.textContent = JSON.stringify(val, null, 2);
          tdv.appendChild(pre);
        } else {
          tdv.textContent = val === null || val === undefined ? "" : String(val);
        }

        tr.appendChild(tdv);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }

    // FUNCIONES de fetch / reset
    async function fetchInfo(email){
      if(!email) { alert("Ingresá un email válido"); return; }
      showStatus("consultando...");
      updateLastCalled();
      document.getElementById("infoCard").hidden = false;

      const url = buildUrl(API_FETCH_URL, email);
      try {
        const resp = await fetch(url, { method: "GET", credentials: "omit" });
        if (!resp.ok) {
          showStatus("error: " + resp.status);
          document.getElementById("resultArea").textContent = "Error: " + resp.status + " — " + await resp.text();
          return;
        }
        const contentType = resp.headers.get("content-type") || "";
        let data;
        if (contentType.includes("application/json")) data = await resp.json();
        else {
          const txt = await resp.text();
          try { data = JSON.parse(txt); } catch(e) { data = { raw: txt }; }
        }

        // si viene envuelto en { data: ... } o { result: ... } desempacar
        if (data && typeof data === "object") {
          const wrapperKeys = ["data", "result", "rows", "items"];
          for (const k of wrapperKeys) {
            if (k in data) { data = data[k]; break; }
          }
        }

        // Si la respuesta es un array con un solo objeto, tomamos el primero
        if (Array.isArray(data) && data.length === 1 && typeof data[0] === "object") data = data[0];

        renderMainTable(data);
        showStatus("resultado recibido");
      } catch (err) {
        showStatus("error de conexión");
        document.getElementById("resultArea").textContent = "Error de conexión: " + String(err);
      }
    }

    async function resetDay(email){
      if(!email) { alert("Ingresá un email válido"); return; }
      if (!confirm("¿Confirmas borrar los datos del día para " + email + " ?")) return;
      showStatus("borrando...");
      updateLastCalled();
      document.getElementById("infoCard").hidden = false;

      const url = buildUrl(API_RESET_URL, email);
      try {
        const resp = await fetch(url, { method: "GET", credentials: "omit" });
        const txt = await resp.text();
        try {
          const json = JSON.parse(txt);
          renderMainTable(json); // si devuelve data actualizada
        } catch(e){
          document.getElementById("resultArea").textContent = txt || "Borrado completado";
        }
        showStatus("borrado completado");
      } catch (err) {
        showStatus("error al borrar");
        document.getElementById("resultArea").textContent = "Error: " + String(err);
      }
    }

    // eventos
    document.getElementById("btnFetch").addEventListener("click", () => fetchInfo(document.getElementById("email").value.trim()));
    document.getElementById("btnReset").addEventListener("click", () => resetDay(document.getElementById("email").value.trim()));
    document.getElementById("btnClearUI").addEventListener("click", () => {
      document.getElementById("resultArea").innerHTML = "";
      document.getElementById("infoCard").hidden = true;
      showStatus("listo");
      document.getElementById("lastCalled").textContent = "";
    });

    // Enter para submit
    document.getElementById("email").addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); fetchInfo(document.getElementById("email").value.trim()); }
    });

    // init
    showStatus("listo");
  </script>
</body>
</html>
